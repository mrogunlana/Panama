version: '3.7'

services:
  rabbitmq:
    container_name: "rabbitmq"
    image: rabbitmq:3.8-management-alpine
    environment:
        - RABBITMQ_DEFAULT_USER=myuser
        - RABBITMQ_DEFAULT_PASS=mypassword
    ports:
        # AMQP protocol port
        - '5672:5672'
        # HTTP management UI
        - '15672:15672'
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 30s
      retries: 3
  db:
      container_name: db
      build: 
        context: ../../Containers/mysql-8.30/.
        dockerfile: ../../Containers/mysql-8.30/Dockerfile.Development
      command: >
          bash -c "
          chmod 644 /etc/mysql/conf.d/*.cnf
          && /entrypoint.sh mysqld --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
          "
      ports: 
        - "3309:3306"
      volumes:
        - ../../Containers/mysql-8.30/data:/var/lib/mysql/
        - ../../Containers/mysql-8.30/conf/custom.cnf:/etc/mysql/conf.d/custom.cnf
        - ../../Containers/mysql-8.30/scripts:/docker-entrypoint-initdb.d
      environment:
        MYSQL_USER: ${DB_USERNAME}
        MYSQL_DATABASE: ${DB_DATABASE}
        MYSQL_PASSWORD: ${DB_PASSWORD}
        MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      healthcheck:
        test: ["CMD", 'mysqladmin', 'ping', '-h', 'localhost', '-u', 'root', '-p$$DB_ROOT_PASSWORD' ]
        timeout: 20s
        retries: 10        
  client:
      container_name: client
      build: 
        context: ../../.
        dockerfile: Samples/Panama.Samples.TestConsole/Dockerfile
      environment:
        POST_COUNT: ${POST_COUNT}
      depends_on:
        service:
          condition: service_healthy
  service:
      container_name: service
      build: 
        context: ../../.
        dockerfile: Samples/Panama.Samples.RabbitMQ.MySql/Dockerfile
      ports: 
        - "5296:5296"
      healthcheck:
        test: curl --fail http://localhost:5296/health || exit 1
        interval: 30s
        timeout: 30s
        retries: 3
      environment:
        DB_HOST: ${DB_HOST}
        DB_PORT: ${DB_PORT}
        BROKER_HOST: ${BROKER_HOST}
        ConnectionStrings__MySql: ${ConnectionStrings__MySql}
        ConnectionStrings__MySqlLogs: ${ConnectionStrings__MySqlLogs}
        ASPNETCORE_URLS: ${SERVICE_PORTS}
      depends_on:
        db:
          condition: service_healthy
        rabbitmq:
          condition: service_healthy

#  start_dependencies:
#      image: dadarek/wait-for-dependencies
#      depends_on:
#        - db
#        - rabbitmq
#      command: db:3309 rabbitmq:15672

volumes:
  dbdata:
    driver: local      
