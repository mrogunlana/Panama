version: '3.7'

services:
  rabbitmq:
    container_name: "rabbitmq"
    image: rabbitmq:3.8-management-alpine
    environment:
        - RABBITMQ_DEFAULT_USER=myuser
        - RABBITMQ_DEFAULT_PASS=mypassword
    ports:
        # AMQP protocol port
        - '5672:5672'
        # HTTP management UI
        - '15672:15672'
  db:
      container_name: db
      build: 
        context: .
        dockerfile: ../../Containers/mysql-8.30/Dockerfile.Development
      command: >
          bash -c "
          chmod 644 /etc/mysql/conf.d/*.cnf
          && /entrypoint.sh mysqld --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
          "
      ports: 
        - "3309:3306"
      volumes:
        - ./data:/var/lib/mysql/
        - ./conf/custom.cnf:/etc/mysql/conf.d/custom.cnf
        - ./scripts:/docker-entrypoint-initdb.d
      environment:
        MYSQL_USER: ${DB_USERNAME}
        MYSQL_DATABASE: ${DB_DATABASE}
        MYSQL_PASSWORD: ${DB_PASSWORD}
        MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD} 
  client:
      container_name: client
      build: 
        context: ../../.
        dockerfile: Samples/Panama.Samples.TestConsole/Dockerfile
      environment:
        HOST: service
      depends_on:
        db:
          condition: service_completed_successfully
        rabbitmq:
          condition: service_completed_successfully
        service:
          condition: service_completed_successfully
  service:
      container_name: service
      build: 
        context: ../../.
        dockerfile: Samples/Panama.Samples.RabbitMQ.MySql/Dockerfile
      ports: 
        - "5296:5296"
      depends_on:
        db:
          condition: service_completed_successfully
        rabbitmq:
          condition: service_completed_successfully
     
volumes:
  dbdata:
    driver: local      
